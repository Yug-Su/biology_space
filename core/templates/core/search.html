{% extends 'core/base.html' %}

{% block title %}Search - SpaceBio AI{% endblock %}

{% block content %}
<br><br><br>
<div class="container mx-auto px-4 py-8" x-data="{
    viewerOpen: false,
    currentArticle: null,
    activeViewerTab: 'content',
    articleSummary: '',
    summaryLoading: false,
    similarArticles: [],

    async openArticle(articleId) {
        this.viewerOpen = true;
        this.currentArticle = null;
        this.articleSummary = '';
        this.activeViewerTab = 'content';

        try {
            const response = await fetch(`/api/article/${articleId}/`);
            const data = await response.json();
            this.currentArticle = data;
            this.similarArticles = data.similar_articles || [];
        } catch (error) {
            console.error('Error loading article:', error);
            alert('Error loading article');
            this.viewerOpen = false;
        }
    },

    async generateSummary() {
        if (!this.currentArticle || this.summaryLoading) return;

        this.summaryLoading = true;
        try {
            const response = await fetch(`/api/article/${this.currentArticle.id}/summarize/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: 'concise'})
            });
            const data = await response.json();

            if (data.summary) {
                this.articleSummary = data.summary;
            } else {
                alert('Error: ' + (data.error || 'Failed to generate summary'));
            }
        } catch (error) {
            console.error('Error generating summary:', error);
            alert('Error generating summary: ' + error.message);
        } finally {
            this.summaryLoading = false;
        }
    }
}">
    <!-- Search Bar -->
    <div class="mb-8">
        <form action="{% url 'core:search' %}" method="GET">
            <div class="flex max-w-4xl mx-auto">
                <input
                    style="color: black";
                    type="text"
                    name="q"
                    value="{{ query }}"
                    placeholder="Search by title, abstract, or author..."
                    class="flex-1 px-6 py-3 rounded-l-lg border-2 border-indigo-300 focus:outline-none focus:border-indigo-500"
                    required
                >
                <select
                    name="year"
                    class="px-4 py-3 border-t-2 border-b-2 border-indigo-300 focus:outline-none focus:border-indigo-500"
                >
                    <option value="">All Years</option>
                    <option value="2024" {% if request.GET.year == '2024' %}selected{% endif %}>2024</option>
                    <option value="2023" {% if request.GET.year == '2023' %}selected{% endif %}>2023</option>
                    <option value="2022" {% if request.GET.year == '2022' %}selected{% endif %}>2022</option>
                    <option value="2021" {% if request.GET.year == '2021' %}selected{% endif %}>2021</option>
                    <option value="2020" {% if request.GET.year == '2020' %}selected{% endif %}>2020</option>
                    <option value="2019" {% if request.GET.year == '2019' %}selected{% endif %}>2019</option>
                    <option value="2018" {% if request.GET.year == '2018' %}selected{% endif %}>2018</option>
                </select>
                <button
                    type="submit"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-r-lg font-semibold transition"
                >
                    Search
                </button>
            </div>
            <div class="mt-3 flex justify-center space-x-6">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="type" value="simple" {% if search_type == 'simple' or not search_type %}checked{% endif %} class="mr-2 text-indigo-600">
                    <span class="text-gray-700">üìù Simple Search</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="type" value="semantic" {% if search_type == 'semantic' %}checked{% endif %} class="mr-2 text-indigo-600">
                    <span class="text-gray-700">ü§ñ Semantic Search (AI - FREE!)</span>
                </label>
            </div>
            <div class="mt-2 text-center text-xs text-gray-600">
                <p>üîç 572 NASA space biology articles ‚Ä¢ AI-powered semantic search using local models</p>
                <p class="mt-1 text-green-600 font-semibold">‚≠ê 176 articles enriched with full PMC content (Introduction, Methods, Results, Conclusions)</p>
            </div>
        </form>
    </div>

    {% if query %}
    <!-- Results -->
    <div class="max-w-6xl mx-auto">
        <div class="mb-6">
            <h2 class="text-2xl font-bold">
                {% if results %}
                    Found {{ results|length }} results for "{{ query }}"
                {% else %}
                    No results found for "{{ query }}"
                {% endif %}
            </h2>
        </div>

        {% if results %}
       <div class="space-y-6">
    {% for result in results %}
        {% if search_type == 'semantic' %}
            {# Semantic search returns (article, score) tuples #}
            {% with article=result.0 score=result.1 %}
            <div @click="openArticle({{ article.id }})" class="bg-black text-white p-6 rounded-lg shadow-md hover:shadow-xl transition border-l-4 border-indigo-500 cursor-pointer group">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-semibold text-white group-hover:text-indigo-400 transition">
                                {{ article.title }}
                            </h3>
                            <span class="px-2 py-1 bg-indigo-900 text-indigo-200 text-xs rounded-full font-semibold">
                                {{ score|floatformat:2 }} similarity
                            </span>
                            {% if article.content %}
                            <span class="px-2 py-1 bg-green-900 text-green-200 text-xs rounded-full font-semibold">
                                ‚≠ê ENRICHED
                            </span>
                            {% endif %}
                        </div>
                        {% if article.abstract %}
                        <p class="text-gray-300 line-clamp-3">
                            {{ article.abstract|truncatewords:50 }}
                        </p>
                        {% endif %}
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-4 text-sm text-gray-400">
                                <span>üìñ {{ article.views_count }} views</span>
                                {% if article.publication_date %}
                                <span>üìÖ {{ article.publication_date|date:"Y" }}</span>
                                {% endif %}
                            </div>
                            <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition">
                                View Article
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
        {% else %}
            {# Simple search returns Article objects #}
            <div @click="openArticle({{ result.id }})" class="bg-black text-white p-6 rounded-lg shadow-md hover:shadow-xl transition cursor-pointer group border-l-4 border-indigo-500">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-semibold text-white group-hover:text-indigo-400 transition">
                                {{ result.title }}
                            </h3>
                            {% if result.content %}
                            <span class="px-2 py-1 bg-green-900 text-green-200 text-xs rounded-full font-semibold">
                                ‚≠ê ENRICHED
                            </span>
                            {% endif %}
                        </div>
                        {% if result.abstract %}
                        <p class="text-gray-300 line-clamp-3">
                            {{ result.abstract|truncatewords:50 }}
                        </p>
                        {% endif %}
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-4 text-sm text-gray-400">
                                <span>üìñ {{ result.views_count }} views</span>
                                {% if result.publication_date %}
                                <span>üìÖ {{ result.publication_date|date:"Y" }}</span>
                                {% endif %}
                                {% if result.keywords %}
                                <span>üè∑Ô∏è {{ result.keywords|length }} keywords</span>
                                {% endif %}
                            </div>
                            <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition">
                                View Article
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>
        {% endif %}
    </div>
    {% else %}
    <!-- No query yet -->
    <div class="max-w-4xl mx-auto text-center">
        <div class="text-6xl mb-4">üîç</div>
        <h2 class="text-2xl font-bold mb-4">Search Space Biology Research</h2>
        <p class="text-gray-600">
            Enter a search query to find relevant articles from NASA's space biology database
        </p>
    </div>
    {% endif %}

    <!-- Article Viewer Modal -->
    {% include 'core/components/article_viewer.html' %}
</div>
{% endblock %}
