{% extends 'core/base.html' %}

{% block title %}Luma Kids - SpaceBio AI{% endblock %}

{% block content %}
<br><br>
<div class="container mx-auto px-4 py-8">
  <div class="max-w-5xl mx-auto" x-data="{
      messages: JSON.parse('{{ messages_json|escapejs }}'),
      newMessage: '',
      loading: false,
      sessionId: '{{ session.session_id|escapejs }}',
      score: {{ luma_score|default:0 }},
      badges: JSON.parse('{{ luma_badges|escapejs }}'),
      async sendMessage() {
        if (!this.newMessage.trim() || this.loading) return;
        const text = this.newMessage.trim();
        this.messages.push({role: 'user', content: text});
        this.newMessage = '';
        this.loading = true;
        try {
          const res = await fetch('{% url 'core:luma_message' %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: text, session_id: this.sessionId })
          });
          const data = await res.json();
          if (data.success) {
            this.messages.push({role: 'assistant', content: data.response});
            this.score = (typeof data.score === 'number') ? data.score : this.score;
            this.badges = Array.isArray(data.badges) ? data.badges : this.badges;
            this.$nextTick(() => {
              const c = document.getElementById('luma-chat-messages');
              if (c) c.scrollTop = c.scrollHeight;
            });
          } else {
            alert('Error: ' + (data.error || 'message not delivered'));
          }
        } catch (e) {
          alert('Network error: ' + e);
        } finally {
          this.loading = false;
        }
      },
      quickSend(text) {
        this.newMessage = text;
        this.sendMessage();
      }
    }">

    <!-- Header avec fond vert uni -->
    <div class="bg-green-600 rounded-2xl shadow-lg p-6 text-white mb-6 mt-5">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-4xl"></div>
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold">Luma — Intergalactic guide for young explorers</h1>
            <p class="text-white/90">Learn space biology through play </p>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-6">
          <!-- Score -->
          <div class="bg-white/15 rounded-xl px-4 py-2 text-center">
            <div class="text-xs uppercase tracking-wider">Score</div>
            <div class="text-2xl font-extrabold" x-text="score"></div>
          </div>
          <!-- Badges -->
          <div class="bg-white/15 rounded-xl px-4 py-2">
            <div class="text-xs uppercase tracking-wider mb-1">Badges</div>
            <div class="flex flex-wrap gap-1">
              <template x-for="b in badges" :key="b">
                <span class="bg-white/20 text-white text-xs px-2 py-1 rounded-full" x-text="b"></span>
              </template>
              <span x-show="!badges || badges.length === 0" class="text-white/70 text-xs">No badges yet</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Starter Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <button @click="quickSend('Bioplant Mission')" class="p-5 rounded-xl bg-green-50 border-2 border-green-300 hover:border-green-400 hover:bg-green-100 transition text-left">
        <div class="text-3xl mb-2">🌱</div>
        <div class="font-bold mb-1 text-green-800">Bioplant Mission</div>
        <p class="text-sm text-gray-700">Discover how plants grow without gravity</p>
      </button>
      <button @click="quickSend('Body in Microgravity')" class="p-5 rounded-xl bg-green-50 border-2 border-green-300 hover:border-green-400 hover:bg-green-100 transition text-left">
        <div class="text-3xl mb-2">🧑‍🚀</div>
        <div class="font-bold mb-1 text-green-800">Body in Microgravity</div>
        <p class="text-sm text-gray-700">What happens to your body in space?</p>
      </button>
      <button @click="quickSend('Cosmic Quiz')" class="p-5 rounded-xl bg-green-50 border-2 border-green-300 hover:border-green-400 hover:bg-green-100 transition text-left">
        <div class="text-3xl mb-2">🧬</div>
        <div class="font-bold mb-1 text-green-800">Cosmic Quiz</div>
        <p class="text-sm text-gray-700">Test your scientific memory</p>
      </button>
    </div>

    <!-- Chat Panel -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-t-4 border-green-600">
      <!-- Ribbon -->
      <div class="px-6 py-3 border-b bg-green-50">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-2xl">🤖</span>
            <div>
              <div class="font-bold text-green-800">Luma</div>
              <div class="text-xs text-gray-600">Play companion (ages 7–12)</div>
            </div>
          </div>
          <div class="flex md:hidden items-center gap-3">
            <div class="text-xs text-gray-600">Score: <span class="font-bold text-green-700" x-text="score"></span></div>
            <div class="text-xs text-gray-600">Badges: <span class="font-bold text-green-700" x-text="(badges||[]).length"></span></div>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="luma-chat-messages" class="h-[28rem] overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-white to-green-50">
        <template x-if="messages.length === 0">
          <div class="text-center text-gray-500 mt-20">
            <div class="text-6xl mb-4">🛸</div>
            <p>Luma is warming up the engines… Choose an adventure to begin!</p>
          </div>
        </template>

        <template x-for="(msg, idx) in messages" :key="idx">
          <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
            <div class="max-w-[85%] rounded-2xl p-4"
                 :class="msg.role === 'user' ? 'bg-green-600 text-white' : 'bg-white border-2 border-green-200 text-gray-800'">
              <div class="text-xs mb-1"
                   :class="msg.role === 'user' ? 'text-green-200' : 'text-green-700 font-semibold'">
                <span x-text="msg.role === 'user' ? 'You' : '🌟 Luma'"></span>
              </div>
              <div class="whitespace-pre-wrap leading-relaxed" x-text="msg.content"></div>
            </div>
          </div>
        </template>

        <template x-if="loading">
          <div class="flex justify-start">
            <div class="bg-white border-2 border-green-200 rounded-2xl p-4">
              <div class="flex space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- Input -->
      <div class="p-4 border-t bg-white">
        <form @submit.prevent="sendMessage" class="flex items-center gap-3">
          <input
            x-model="newMessage"
            type="text"
            placeholder="Type your choice or question… (e.g., 1, Bioplant, True/False)"
            class="flex-1 px-4 py-3 border-2 border-green-300 rounded-xl focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-200"
            :disabled="loading"
          />
          <button
            type="submit"
            class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-xl font-semibold transition disabled:opacity-50"
            :disabled="loading || !newMessage.trim()"
          >
            Send
          </button>
        </form>
        <!-- Quick actions -->
        <div class="mt-3 flex flex-wrap gap-2">
          <button @click="quickSend('1')" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200">1</button>
          <button @click="quickSend('2')" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200">2</button>
          <button @click="quickSend('3')" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200">3</button>
          <button @click="quickSend('True')" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-800 hover:bg-green-200 font-semibold">True</button>
          <button @click="quickSend('False')" class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200">False</button>
          <button @click="quickSend('Continue mission')" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200">Continue</button>
          <button @click="quickSend('Change game')" class="text-sm px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200">Change game</button>
        </div>
      </div>
    </div>

    <!-- Info Panel -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-md p-6 border-l-4 border-green-600">
        <h3 class="font-bold text-lg mb-3 text-green-800">🎯 How Luma plays</h3>
        <ul class="text-sm text-gray-700 space-y-2">
          <li>• Short answers (1–3 sentences) with emojis</li>
          <li>• Quizzes, riddles, true/false, interactive mini-adventures</li>
          <li>• Based on simple facts from space biology articles</li>
          <li>• Provides "Learn more" links when available</li>
          <li>• Rewards: points and badges for your achievements</li>
        </ul>
      </div>
      <div class="bg-white rounded-2xl shadow-md p-6 border-l-4 border-green-600">
        <h3 class="font-bold text-lg mb-3 text-green-800">🧪 Exploration ideas</h3>
        <div class="flex flex-wrap gap-2">
          <button @click="quickSend('Why do roots get lost in microgravity?')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-sm border border-green-200">Roots & gravity</button>
          <button @click="quickSend('How do astronauts eat in space?')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-sm border border-green-200">Eating in space</button>
          <button @click="quickSend('Muscles in space')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-sm border border-green-200">Muscles</button>
          <button @click="quickSend('Bones in space')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-sm border border-green-200">Bones</button>
          <button @click="quickSend('Plants on the ISS')" class="px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg text-sm border border-green-200">Plants</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}